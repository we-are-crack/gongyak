import path from 'path';
import { fileURLToPath } from 'url';
import fetch from 'node-fetch'; // 추가

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export const home = (req, res) => {
  console.log('home controller called'); // 디버깅용 로그
  res.sendFile(path.join(__dirname, 'client', 'home.html'));
};

// 공약 데이터를 처리하는 컨트롤러
export const fetchPledges = async (req, res) => {
  try {
    // const response = await fetch('http://localhost:4000/ai');

    // if (!response.ok) {
    //   throw new Error(`AI 서버 응답 오류: ${response.status}`);
    // }

    // let data = await response.json();

    let data = {
      htmlData:
        '```html\n<div class="candidate-container">\n  <div class="candidates-grid">\n    <div class="candidate-card peoplepowerparty">\n      <div class="candidate-header">\n        <a\n          href="https://storage.googleapis.com/gongyak21_public/resources/candidate_image/None.png"\n        >\n          <img\n            class="candidate-photo"\n            src="https://storage.googleapis.com/gongyak21_public/resources/candidate_image/None.png"\n            alt="윤석열 얼굴"\n          />\n        </a>\n        <h2>윤석열</h2>\n      </div>\n      <div class="main-pledge">\n        청년들의 목돈 마련을 위해 청년도약계좌를 도입합니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_156.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_156.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>근로 사업 소득이 있는 청년(19~34세)의 중장기 재산 형성을 돕기 위한 ‘청년도약계좌’ 도입</li>\n        <li>월 70만원씩 연 3.5% 복리로 10년을 납입하면 1억 원 적립</li>\n        <li>생애 최초 주택 구입, 장기 실직, 질병 등에 의한 장기 휴직, 재해 등의 경우에는 중도 인출과 재가입 허용</li>\n      </ul>\n      <div class="main-pledge">\n        청년들이 꿈을 펼칠 수 있는 농촌을 만들겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_157.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_157.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>청년농 3만 명 육성을 위한 종합적인 지원 대책 마련</li>\n        <li>간척지 등 대규모 공공 농지 우선 배정</li>\n        <li>농촌 뉴타운 조성 사업 통해 공공 주택 우선 배정</li>\n        <li>농식품 분야 스타트업 육성 지원</li>\n        <li>경영 컨설팅, 채무 조정 지원 등 경영 회생 프로그램 마련</li>\n        <li>후계농업경영인육성자금 지원 한도 및 상환 기간 확대</li>\n        <li>청년농 직불제 도입 및 청년농 육성 전담 조직 신설</li>\n        <li>후계농의 영농 가업 승계를 위해 상속세 공제 가액 상향</li>\n      </ul>\n      <div class="main-pledge">\n        청년 원가주택 30만 호, 역세권 첫 집 주택 20만 호 공급.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_13.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/국민의힘_윤석열/half_images/page_13.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>불합리한 청약 제도 개선</li>\n        <li>청년 취업 후 상환 대출 제도 취업준비생까지 확대</li>\n        <li>소득 있는 청년의 중장기 재산 형성을 돕기 위한 청년도약계좌 도입</li>\n        <li>청년농 직불제 도입 등 청년농 3만 명 육성 종합 대책 마련</li>\n      </ul>\n    </div>\n    <div class="candidate-card theminjoo">\n      <div class="candidate-header">\n        <a\n          href="https://storage.googleapis.com/gongyak21_public/resources/candidate_image/leejaemyung.png"\n        >\n          <img\n            class="candidate-photo"\n            src="https://storage.googleapis.com/gongyak21_public/resources/candidate_image/leejaemyung.png"\n            alt="이재명 얼굴"\n          />\n        </a>\n        <h2>이재명</h2>\n      </div>\n      <div class="main-pledge">\n        청년의 기본적 삶을 국가가 책임지겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>2023년부터 만 19세~29세 청년 대상 연간 100만 원 기본소득 지급</li>\n        <li>청년에게 장기간 저렴한 금리로 최대 1,000만 원 기본 대출, 500만 원~1,000만 원 한도 저축 시 일반 금리보다 높은 금리를 적용하는 기본저축</li>\n      </ul>\n      <div class="main-pledge">\n        청년 일자리를 확대하고 질 높은 교육 훈련을 제공하겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>공공기관 청년고용 의무비율 기관별 정원의 3%에서 5%로 상향 추진</li>\n        <li>정부·지자체·기업 협력 양질의 직업 훈련 모델 개발</li>\n        <li>국민 내일배움카드 청년지원금 2배 증액하고 다양한 직업훈련기관 확대</li>\n        <li>공정 채용 법제화 및 대상 확대, 채용 과정상에 사생활 침해와 성차별이 없도록 법률 개정</li>\n        <li>고용보험 수급 기준 개선하여 청년 자발적 이직 시 생애 한 번 구직급여 지급</li>\n        <li><청년 취업면접 완벽 지원>, <경력증명서 온라인 발급>을 통한 구직자 권리 보장</li>\n      </ul>\n      <div class="main-pledge">\n        촘촘한 맞춤형 청년복지 정책 사각지대를 해소하겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>청년 마음건강 지원사업 확대</li>\n        <li>지방정부 청년 마음건강 지원사업 통합 관리체계 마련 및 정부지원 강화</li>\n        <li>진단 전 초기 단계 심리 지원이 필요한 청년 대상 마음건강 바우처 지원 확대</li>\n        <li>구직 단념 청년(NEET)에게 맞춤형 \'청년 위기 극복 1:1 프로젝트\' 시행</li>\n      </ul>\n      <div class="main-pledge">\n        대학생 지원을 강화하겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_25.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>대학 학점비례 등록금제 도입 및 학자금 대출이자 지원사업 확대</li>\n        <li>부모 소득·재산 상관없이 취업 후 상환 학자금 지원 및 대학원생 이용대상 확대</li>\n        <li>학자금 대출 상환 유예제도 확대 및 생활비 대출한도 증액 추진</li>\n        <li>국가장학재단 연간생활비대출한도액 상향 등 현실화</li>\n      </ul>\n      <div class="main-pledge">\n        미래를 이끌 청년들의 정치참여와 도전을 지원하겠습니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_322.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_322.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>각급 선거 최초 출마 만 34세 이하 청년후보자의 기탁금 폐지 등 청년 후보자들의 도전 장벽 제거 추진</li>\n        <li>청년 후보자의 국회의원 및 지방의원 선거비용 보전기준 하향 조정</li>\n        <li>정당의 청년후보자 추천을 촉진할 수 있도록 청년추천보조금제 도입</li>\n        <li>성별·지역을 고려한 청년 공천 의무비율제 도입</li>\n        <li>청년의 요구를 반영하기 위해 청년정책 담당 수석비서관·청년 특임장관 신설</li>\n        <li>각 부처 청년예산에 실질적인 총액배분 자율성 보장, 국민참여예산에 청년참여예산 쿼터제 적용, 청년정책조정위원회의 심의·조정 기능 강화</li>\n        <li>청년참여단 개편으로 \'청년의회\' 상설화</li>\n      </ul>\n      <div class="main-pledge">\n        청년의 과학기술 인력 지원을 강화합니다.\n        <a class="refimg" href="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_26.jpg" target="_blank">\n          이미지 보기\n          <span class="refimg-preview">\n            <img src="https://storage.googleapis.com/gongyak21_public/resources/더불어민주당_이재명/half_images/page_26.jpg" alt="공약 참고 이미지 미리보기" />\n          </span>\n        </a>\n      </div>\n      <ul>\n        <li>청년과학기술인에 대한 지원 강화</li>\n      </ul>\n    </div>\n  </div>\n</div>\n<!-- 후보자별 공약 요약 비교 섹션 추가 -->\n<div class="summary-section">\n  <h3>후보자별 교육 공약 요약 비교</h3>\n  <table class="summary-table">\n    <thead>\n      <tr>\n        <th>후보자</th>\n        <th>핵심 공약 요약</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td><span class="summary-cand summary-cand-peoplepowerparty">윤석열</span></td>\n        <td>\n          <ul>\n            <li>청년도약계좌 도입, 청년농 3만 명 육성, 청년 원가주택 공급</li>\n          </ul>\n        </td>\n      </tr>\n      <tr>\n        <td><span class="summary-cand summary-cand-theminjoo">이재명</span></td>\n        <td>\n          <ul>\n            <li>청년 기본소득 및 금융 지원, 청년 일자리 확대 및 직업 훈련, 청년 복지 강화, 대학생 지원</li>\n            <li>청년 정치 참여 지원, 청년 과학기술 인력 지원</li>\n          </ul>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n<hr class="border-gray-300 mb-4" />\n```',
      search: '청년도약계좌에관한공약이있어',
      status: 'ok',
    };

    // htmlData 앞 7글자, 뒤 3글자 삭제
    data.htmlData = data.htmlData.substring(7, data.htmlData.length - 3);

    res.set('Content-Type', 'application/json; charset=utf-8');
    res.status(200).json(data);
  } catch (error) {
    console.error('fetchPledges Error:', error);
    res.status(500).json({
      search: '',
      status: 'error',
      htmlData: '',
    });
  }
};
